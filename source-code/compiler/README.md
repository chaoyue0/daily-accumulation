# 编译模块
Vue的编译分为三个阶段，即解析(Parse)、转换(Transform)和代码生成(Codegen)

- 解析阶段：将`模板字符串`转换为`抽象语法树`(AST)
- 转换阶段：对AST做一些转换处理
- 代码生成阶段：根据AST生成相应的`render渲染函数`

AST节点：
- ns：命名空间，默认HTML，即0
- tag：标签名
- tagType：元素类型
- isSelfClosing：是否是自闭合标签
- props：属性，包含HTML属性和指令
- children：子节点

## 辅助函数和变量
### _ctx
定义：用于表示组件实例的上下文，在模板中需要访问组件实例的属性和方法，可以使用_ctx来引用组件实例，它实际上是一个命名空间，
用于将`模板中的变量`和`组件实例上的属性和方法`进行关联

### advanceBy 缩进函数
定义：帮助编译器在文本中前进指定数量的字符

根据指定的字符数前进，更新解析的位置信息，并截取剩余的文本，以便进一步解析下一个字符

#### advancePositionWithMutation 更新位置
定义：在解析过程中更新位置信息，以便准确地跟踪当前字符的位置

根据`前进的字符数量`和模板文本中的`换行符`，更新解析位置的信息，以便在解析模板文本时能够准确地跟踪字符的行、列、偏移等位置

变量：linesCount(记录换行符数量)和lastNewLinePos(最后一个换行符)

换行符判断：`source.charCodeAt()`(换行符的char code为10)，如果是，则增加linesCount计数，同时更新lastNewLinePos为当前位置

更新位置信息：

- 将位置的`offset属性`增加前进的`字符数量`
- 将位置的`line属性`增加记录的`换行数量`(linesCount)
- 根据是否存在换行符，更新位置的`column属性`:
    - 如果没有换行符，直接增加前进的字符数量：`pos.column + numberOfCharacters`
    - 如果有换行符，计算当前行最后一个换行符后的字符数：`numberOfCharacters - lastNewLinePos`

### helper 引入辅助函数
定义：通过维护一个`计数器`，可以确保在引入多次相同辅助函数时，只引入一次并记录引入次数

作用：优化编译输出，避免重复引入相同的辅助函数

## Parse 解析阶段
在模板解析过程中，解析器会根据一定的规则来将模板字符串进行分隔，具体的分割逻辑：

- 标签分隔：根据 < 和 > 来识别标签，遇到左尖括号识别这是一个标签的开始，会一直解析遇到右尖括号为止
- 插值分隔：根据 {{ 和 }} 来识别插值表达式
- 空白字符分隔：包括空格、换行符等
- 特定标记分隔：如 <!-- 和 --> 注释的起始和结束标记

分析模板字符串时，主要分为两种情况：以’<'开头的字符串、不是以'<'开头的字符串

### 以’<'开头的字符串

- 元素开始标签
- 元素结束标签
- 注释节点
- 文件声明

### 不以’<'开头的字符串

- 文本节点
- 插入表达式

### baseParse 入口函数
定义：接收一个模板字符串作为参数，在函数中会初始化一些状态和变量，调用parse函数来进行实际的解析过程

#### createParserContext
定义：创建一个`解析器上下文对象`，这个对象将会在解析模板字符串的过程中保存一些`状态和选项`，比如当前解析的行数、列数、字符串偏移量等

1、创建解析器上下文对象

2、遍历传入的原始选项，如果选项的属性为undefined，则传入默认选项属性

3、返回解析器上下文对象，它包含了解析过程中的状态和选项

#### getCursor 获取起始的光标位置
1、从解析器上下文中获取`列号、行号、字符偏移量`

2、返回包含光标位置信息的`对象`

#### createRoot 生成AST的根节点
##### parseChildren 解析子节点
定义：该函数负责在解析过程中遍历模板字符串，根据`不同的子节点类型`进行相应的解析，并将解析得到的子节点存储在一个数组中返回

步骤：

1、获取父元素：通过ancestors数组获取解析的父元素节点，并跟踪当前解析的嵌套层级

2、确定命名空间：根据父元素的命名空间，决定当前节点的命名空间

3、初始化节点数组：存储解析的子节点

4、循环解析子节点：不断解析模板的各种子节点，直到遇到结束标记

5、解析不同类型的子节点：文本节点、标签节点、注释节点、插值表达式节点、其他情况节点

6、将解析的节点添加到数组node
##### getSelection 获取解析的范围
定义：用于根据起始和结束的`光标位置信息`，生成一个源代码范围`对象`，包含范围的起始位置、结束位置、范围内的源代码

    光标位置信息：代码或文本中某个特定位置的位置描述，包含列号、行号、字符偏移量三个属性，确定了字符串的具体位置

## Transform 转换阶段
在parse阶段生成一颗AST后，只是针对`模板的简要解析`，无法转换为最终的DOM树，因为有些`特殊指令`可能会生成多个元素节点(v-for)或不生产节点(v-if)

    parse阶段生成的AST语法树是针对模板语法的解析，不具备一些指令功能上的扩展
### transform 转换函数
定义：负责将解析得到的AST进行一系列的转换操作，以准备生成最终的渲染代码

#### createTransformContext
建立一个transform的上下文，用来提供全局的辅助方法和存储对应的状态

#### traverseNode
用于在转换过程中遍历抽象语法树的节点，并应用相应的转换插件(`nodeTransforms`节点转换插件数组)，用来处理模板中的各种节点

1、从上下文中获取到要应用的`节点转换插件数组`

2、创建exitFns空数组，用来存储转化插件返回的退出函数(clean up)

3、遍历节点转换插件数组，调用当前插件函数，传入当前节点和上下文

4、检查是否在插件转换过程中将当前节点`删除`，如果删除了则不再继续处理，如果没有删除可能发生节点的`替换`则更新当前节点

5、根据节点类型进行不同的处理：

- 对于注释节点(NodeTypes.COMMENT)，引入注释的创建函数`helper`
- 对于插值节点(NodeTypes.INTERPOLATION)，引入对应的创建函数`helper`
- 对于容器类型的节点，如条件节点(NodeTypes.IF)、循环节点(NodeTypes.FOR)、元素节点(NodeTypes.ELEMENT)、根节点(NodeTypes.ROOT)，递归遍历其子节点，调用traverseNode函数

6、遍历之前存储退出函数数组exitFns，并依次执行这些函数，进行一些清理工作


#### hoistStatic 静态节点提升
定义：优化静态节点渲染，通过遍历AST树并将`静态节点或属性`提升到渲染函数之外，以减少运行时的处理和渲染开销

##### 静态节点
静态节点是初始渲染时被计算和生成，并且在组件的生命周期中保持不变，不会受到数据变化的影响(`普通元素和文本`)

##### walk 函数
1、初始化子节点的数量和可提升节点的数量

2、只有`普通元素和文本节点`的静态节点才能被提升，如果节点不能被提升则赋值不可被提升`NOT_CONSTANT`的标记，可以被提升则赋值可提升`HOISTED`的标记

3、提升节点，将节点存储到context的`hoist数组`中

4、`提升节点数量`自加1

5、包含动态绑定的节点本身不会提升，节点上可能存在静态属性`props`，静态属性可以被提升，执行`context.hoist，提升props`

6、节点是组件、节点带有v-for指令、节点带有v-if指令，`递归调用walk函数`

## Codegen 代码生成阶段

### generate 函数
定义：创建一个用于代码生成的上下文对象，接收两个参数：输入转换后的`抽象语法树`AST和一个`配置对象`(CodegenOptions)

#### 创建代码生成上下文
定义：创建一个context对象，用于存储生成代码的上下文信息

context对象中包含从参数中传入的配置对象相关属性，以及额外的属性和方法：

额外的属性包括：源代码、列号、行号、偏移量、缩进级别、代码映射信息

##### push
定义：用于将生成的代码添加到上下文对象中，并且在需要时维护`源码映射信息`，从而能够在调试时准确地将`生成代码与源码进行关联`，
帮助定位和解决问题

1、是否在浏览器环境且需要生成源码映射信息，在非浏览器环境中，可能会需要源码映射用于`调试和错误定位`

2、判断当前节点是否是一个需要进行源码映射的表达式，是的话进行相关的`变量引用`

3、将节点内容中的`_ctx`替换为空字符串，得到实际的变量名，以便在生成的代码中`建立正确的映射关系`

4、判断替换后的变量名是否与原节点内容相同，是的话将处理后的变量名赋值给变量`name`

5、`addMapping(loc,name?)`根据节点的`起始位置`和变量名，将映射信息添加到源码映射中

6、调用`advancePositionWithMutatio`n函数来根据生成的代码`更新位置信息`，以便在源码映射中记录正确的位置

7、addMapping(node.loc.end)根据节点的`结束位置`，将结束位置的映射信息添加到源码映射中

