# 初始化渲染

## Monorepo
定义：指将多个项目放到一个仓库的一种管理项目的策略

### 好处

- 只需要一个仓库，就可以便捷的管理多个项目
- 可以管理不同项目中的相同第三方依赖，做到依赖的同步更新
- 可以使用其他项目的代码，清晰地建立起项目间的依赖关系

### 优化
monorepo的方式对很多模块做了颗粒度的包拆分，核心响应式放在package/reactivity中，创建渲染器放在package/runtime-core中，
如果没有用到createApp方法，当前的runtime-dom这个包是可以通过tree-shaking去避免打包

## createApp

### ensureRenderer
定义：确保渲染器render实例的存在，并在需要时创建它

目的：确保在需要时只创建一个渲染器实例，并且在多次调用时返回同一个实例，保证只存在一个全局的渲染器实例，确保了全局唯一性

#### baseCreateRenderer
定义：配置渲染器的各种选项和方法，以便vue可以将虚拟DOM渲染到实际的DOM上

通过解构赋值从options参数中提取一系列DOM操作相关的函数和方法，包括插入元素、删除元素、设置属性等

最后返回一个render方法(包含patch方法)和createApp方法(render作为参数)

##### patch
定义：用于比较新旧虚拟节点并进行DOM更新

###### patchFlag

- 动态文字内容：TEXT = 1
- 动态class：CLASS = 1 << 1
- 动态样式：STYLE = 1 << 2
- 动态props：PROPS = 1 << 3
- 动态的key，props对象的key是动态的：FULL_PROPS = 1 << 4
- 合并事件： HYDRATE_EVENTS = 1 << 5
- 静态节点： HOISTED = -1
- 节点diff结束： BAIL = -2


    为什么要使用位运算符？
    对每个flag使用二进制数中的某一位来表示，每个变量都至少有一位是1
    1、容易复合，通过TEXT | CLASS来得到0000000011，而这个值可以表示他即有TEXT的特性，也有CLASS的特性
    2、方便对比，拿到一个值FLAG时，判断是否有TEXT特性，只需要FLAG & TEXT > 0
    3、方便扩展，在位数足够的情况下，新增特性只需要位数左移一位
    注：系统的权限管理也可以这样子考虑

###### 步骤
1、简单比较，如果n1和n2相等，表示两个虚拟节点相同，无需进行更新，直接返回(n1表示旧节点，n2表示新节点)

2、如果n1存在，且n1和n2不是相同类型的虚拟节点，表示需要卸载旧节点，调用unmount函数执行卸载操作，并将n1置为null

3、如果patchFlag是BAIL表示需要重新创建整个节点树

4、根据n2的节点类型，通过switch执行不同的处理逻辑，包括文本节点、注释节点、静态节点等不同类型的虚拟节点

##### render
1、接收三个参数：vNode表示要渲染的虚拟节点、container表示要将虚拟节点渲染到的容器元素、isSVG表示是否要渲染为SVG元素

2、检查vNode，如果为null或undefined，表示没有要渲染的内容，接着判断容器元素是否已经有旧的虚拟节点，有的话此时执行卸载操作

3、如果不为null，表示有新的虚拟节点要渲染，调用patch函数进行更新

4、接着调用两个函数用于执行在渲染过程中注册的预处理和后处理回调函数

5、最后将vNode赋值给容器的_vNode属性，以便下次渲染时可以检查是否存在旧的虚拟节点

##### createAppAPI